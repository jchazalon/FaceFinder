<!-- File: template.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Face Search Preview</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; padding: 8px; border-radius: 6px; text-align: center; background: #fff; }
    img { width: 120px; height: 120px; object-fit: cover; display:block; margin: 0 auto 8px; }
    .meta { font-size: 12px; color: #333; word-break: break-word; }
    .controls { margin-bottom: 12px; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Face Search Preview</h2>
  <div class="controls">
    <button id="prev" class="btn">Previous</button>
    <button id="next" class="btn">Next</button>
    <span id="info"></span>
  </div>
  <div id="grid" class="grid"></div>

<script>
const items = {{ items_json | safe }};
const pageSize = {{ page_size }};
let page = 0;

function renderPage() {
  const start = page * pageSize;
  const end = Math.min(start + pageSize, items.length);
  document.getElementById('grid').innerHTML = '';

  for (let i = start; i < end; i++) {
    const it = items[i];
    const a = document.createElement('a');
    a.href = it.full_path;
    a.target = '_blank';
    a.className = 'card-link';

    const card = document.createElement('div');
    card.className = 'card';

    const img = document.createElement('img');
    img.dataset.src = it.thumbnail;
    img.alt = it.file;
    img.loading = 'lazy';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerText = it.file + '\n' + JSON.stringify(it.region);

    card.appendChild(img);
    card.appendChild(meta);
    a.appendChild(card);
    document.getElementById('grid').appendChild(a);
  }

  document.getElementById('info').innerText = `Showing ${start+1}-${end} of ${items.length}`;
  observeImages();
}

function observeImages() {
  const imgs = document.querySelectorAll('img[data-src]');
  const obs = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        observer.unobserve(img);
      }
    });
  }, { rootMargin: '200px' });
  imgs.forEach(img => obs.observe(img));
}

document.getElementById('prev').addEventListener('click', () => { if (page>0) { page--; renderPage(); } });
document.getElementById('next').addEventListener('click', () => { if ((page+1)*pageSize < items.length) { page++; renderPage(); } });

renderPage();
</script>
</body>
</html>